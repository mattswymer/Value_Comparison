<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Value Comparisons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    /* -------------------
     * Global Styles
     * ------------------- */
    :root{
      --bg:#fff; --fg:#0f172a; --subtle:#475569; --muted:#94a3b8; --border:#e5e7eb;
      --fill:#f8fafc; --accent:#2563eb; --accent-weak:#dbeafe; --danger:#b91c1c;
      --ok:#16a34a; --focus:#1d4ed8; --card:#fff; --shadow:0 1px 2px rgba(0,0,0,.04), 0 4px 16px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --fg:#e5e7eb; --subtle:#cbd5e1; --muted:#94a3b8; --border:#1f2937;
        --fill:#111827; --accent:#60a5fa; --accent-weak:#0b2942; --danger:#f87171; --ok:#34d399; --card:#0f172a; --shadow:none;
      }
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--fg); }
    img{ max-width:100%; display:block; }
    a{ color:var(--accent); text-decoration:none; } a:hover{ text-decoration:underline; }

    /* -------------------
     * Layout & Components
     * ------------------- */
    .page{ min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
    header.header{ position:sticky; top:0; z-index:20; background:var(--bg); border-bottom:1px solid var(--border); padding:.75rem 1rem; }
    main{ padding:1rem; max-width:920px; width:100%; margin:0 auto; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); }
    .section{ padding:1rem; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .row{ display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; }
    .hidden{ display:none !important; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border-width:0; }

    /* Header */
    .header__row{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:.75rem; }
    .title{ margin:0; font-size:clamp(1.1rem,2vw+.2rem,1.5rem); letter-spacing:.2px; }
    .subtitle{ margin:.25rem 0 0 0; color:var(--subtle); font-size:.95rem; }
    .header__actions{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:end; }

    /* Form Elements */
    label{ display:block; font-weight:600; margin-bottom:.25rem; }
    input[type="text"],input[type="url"],input[type="number"],input[type="date"]{
      width:100%; background:var(--fill); border:1px solid var(--border); color:var(--fg);
      padding:.625rem .75rem; border-radius:10px; outline:none; }
    input:focus{ border-color:var(--focus); box-shadow:0 0 0 3px color-mix(in oklab, var(--focus) 20%, transparent); }
    .hint{ color:var(--muted); font-size:.9rem; }
    fieldset{ border:0; padding:0; margin:0; }

    /* Buttons */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.625rem 1rem;
      border-radius:10px; border:1px solid var(--border); background:var(--fill); color:var(--fg); cursor:pointer; min-width:8.5rem; font-weight:600; }
    .btn:hover{ filter:brightness(0.98); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-primary{ background:var(--accent); color:#fff; border-color:color-mix(in oklab, var(--accent) 80%, black); }
    .btn-danger{ background:color-mix(in oklab, var(--danger) 15%, var(--fill)); color:var(--danger); border-color:color-mix(in oklab, var(--danger) 50%, var(--border)); }
    .btn-ghost{ background:transparent; border-color:var(--border); }

    /* Progress Bar */
    .progress{ display:flex; align-items:center; gap:.75rem; margin:.5rem 0 0; }
    .bar{ flex:1; height:8px; background:var(--border); border-radius:999px; overflow:hidden; }
    .bar>span{ display:block; height:100%; width:0%; background:var(--accent); transition:width .2s ease; }
    .progress__text{ color:var(--subtle); font-size:.9rem; }

    /* Item Selection Choices */
    .choices{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .choice{ position:relative; padding:1rem; cursor:pointer; user-select:none; border:1.5px solid var(--border); border-radius:12px;
      transition:border-color .15s, box-shadow .15s, background .15s; background:var(--card);
      display:grid; grid-template-rows:auto 1fr auto; gap:.5rem; }
    .choice:hover{ border-color:var(--accent); }
    .choice input[type="radio"]{ position:absolute; inset:0; opacity:0; }
    .choice__img{ aspect-ratio:4/3; width:100%; border-radius:10px; background:var(--fill); border:1px dashed var(--border);
      display:flex; align-items:center; justify-content:center; overflow:visible; }
    .choice__img img{ width:auto; height:auto; max-width:100%; max-height:100%; object-fit:contain; }
    .choice__caption{ color:var(--subtle); font-size:.95rem; min-height:1.25rem; line-height:1.25rem; }
    .choice.selected{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 20%, transparent);
      background:color-mix(in oklab, var(--accent-weak) 40%, var(--card)); }
    .choice:focus-within{ outline:3px solid color-mix(in oklab, var(--focus) 30%, transparent); outline-offset:2px; }

    /* Price/URL Inputs */
    .inputs-wrap{ min-height:16rem; }
    .inputs{ margin-top:1rem; display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
    .inputs .panel{ padding:1rem; }
    .inputs--hidden{ visibility:hidden; pointer-events:none; }
    .requirement{ margin-top:.5rem; color:var(--subtle); }
    .validation{ min-height:1.5rem; font-size:.92rem; }
    .validation--error{ color:var(--danger); }
    .validation--ok{ color:var(--ok); }

    /* Navigation Bar */
    .navbar{ position:sticky; bottom:0; z-index:10; background:var(--bg); border-top:1px solid var(--border); padding:.75rem 1rem;
      display:grid; grid-template-columns:1fr 1fr; align-items:center; gap:.5rem; }
    .navbar .right{ text-align:right; }

    /* Summary View */
    .summary h2{ margin-top:0; }
    .summary .pair{ padding:.75rem 1rem; border:1px solid var(--border); border-radius:10px; margin-bottom:.75rem; background:var(--card); }
    .summary .pair__title{ font-weight:700; margin:0 0 .25rem 0; }
    .summary .pair__body{ display:grid; gap:.5rem; grid-template-columns:1fr 1fr; }
    .summary .item{ display:flex; flex-direction:column; gap:.2rem; }
    .summary .name{ font-weight:600; }
    .summary .name .chosen{ color:var(--accent); font-weight:800; margin-right:.25rem; }
    .summary .small{ color:var(--muted); font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:.92rem; }

    /* -------------------
     * Responsive & Print Styles
     * ------------------- */
    @media print{
      header.header, .navbar, .header__actions, .requirement, .validation, .choices, .inputs-wrap, #itemsView .section>.row, #toItemsBtn { display:none !important; }
      main{ max-width:unset; padding:0; }
      .summary{ display:block !important; }
      @page{ margin:12.7mm; } body{ font-size:11pt; }
      .summary .pair{ page-break-inside:avoid; }
    }
    @media (max-width:840px){
      .inputs{ grid-template-columns:1fr; }
      .choices{ grid-template-columns:1fr 1fr; }
      .grid-2{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body class="page">
  <header class="header">
    <div class="header__row">
      <div>
        <h1 class="title">Value Comparisons</h1>
        <p class="subtitle">Pick which item costs more, then enter the price and paste a link for <strong>both</strong> items.</p>
      </div>
      <div class="header__actions">
        <button id="startResumeBtn" class="btn btn-primary" type="button">Start</button>
        <button id="summaryBtn" class="btn btn-ghost" type="button" aria-controls="summaryView">Summary</button>
        <button id="resetBtn" class="btn btn-danger" type="button">Reset all answers</button>
      </div>
    </div>
    <div class="progress" aria-live="polite">
      <div class="bar" aria-hidden="true"><span id="progressBar"></span></div>
      <div id="progressText" class="progress__text">Pair 1 of 18 ‚Ä¢ Completed 0 of 18 ‚Ä¢ 0% complete</div>
    </div>
  </header>

  <main>
    <section id="itemsView">
      <div class="card section">
        <div class="grid-2">
          <div>
            <label for="studentName">Student name</label>
            <input id="studentName" type="text" placeholder="Your name" autocomplete="name" />
          </div>
          <div>
            <label for="workDate">Date</label>
            <input id="workDate" type="date" />
          </div>
        </div>
        <div class="mt-3">
          <h2 class="mt-0">Steps</h2>
          <ol class="mt-1">
            <li>Select the item you think is more expensive.</li>
            <li>Enter the price and paste the URL for <em>both</em> items.</li>
            <li>Open <strong>Summary</strong>, click <strong>Print / Save PDF</strong>, then upload to Canvas.</li>
          </ol>
           <p class="hint">Your work saves automatically on this device.</p>
        </div>
      </div>

      <div class="card section mt-3" aria-labelledby="pairTitle">
        <h2 id="pairTitle" class="mb-0">Pair 1 of 18</h2>
        <p id="pairHelp" class="hint mt-1">Choose the item you think is most expensive.</p>
        <fieldset class="mt-3">
          <legend class="sr-only">Choose the item you think is most expensive.</legend>
          <div class="choices" role="radiogroup" aria-labelledby="pairTitle">
            <label class="choice" data-side="left">
              <div class="choice__img"><img id="imgLeft" alt="Item A" loading="lazy" decoding="async" referrerpolicy="no-referrer" /></div>
              <div class="choice__caption" id="capLeft"></div>
              <input type="radio" name="choice" value="left" />
            </label>
            <label class="choice" data-side="right">
              <div class="choice__img"><img id="imgRight" alt="Item B" loading="lazy" decoding="async" referrerpolicy="no-referrer" /></div>
              <div class="choice__caption" id="capRight"></div>
              <input type="radio" name="choice" value="right" />
            </label>
          </div>
        </fieldset>

        <div class="inputs-wrap">
          <div class="inputs inputs--hidden" id="inputs">
            <div class="panel card">
              <h3 id="leftTitle" class="mt-0"></h3>
              <label for="leftPrice">Price (USD)</label>
              <input id="leftPrice" name="leftPrice" inputmode="decimal" placeholder="$0.00" />
              <p class="hint mt-1">Enter a non-negative price. You can include ‚Äú$‚Äù and commas.</p>
              <label for="leftUrl" class="mt-3">Product page URL</label>
              <input id="leftUrl" name="leftUrl" type="url" placeholder="https://example.com/product" />
            </div>
            <div class="panel card">
              <h3 id="rightTitle" class="mt-0"></h3>
              <label for="rightPrice">Price (USD)</label>
              <input id="rightPrice" name="rightPrice" inputmode="decimal" placeholder="$0.00" />
              <p class="hint mt-1">Enter a non-negative price. You can include ‚Äú$‚Äù and commas.</p>
              <label for="rightUrl" class="mt-3">Product page URL</label>
              <input id="rightUrl" name="rightUrl" type="url" placeholder="https://example.com/product" />
            </div>
          </div>
        </div>
        <div class="requirement">Requirement: Enter a price and a valid URL for both items.</div>
        <div id="validation" class="validation" aria-live="polite"></div>
      </div>
    </section>

    <section id="summaryView" class="summary hidden">
      <div class="row">
        <h2 class="mt-0">Summary</h2>
        <button id="toItemsBtn" class="btn btn-ghost" type="button">Back to Items</button>
      </div>
      <p class="hint">The chosen option is marked with an asterisk (*).</p>
      <div id="summaryHeader" class="card section mt-2">
        <div class="grid-2">
          <div><strong>Student:</strong> <span id="summaryStudent">‚Äî</span></div>
          <div><strong>Date:</strong> <span id="summaryDate">‚Äî</span></div>
        </div>
      </div>
      <div id="summaryList" class="mt-3"></div>
      <div class="summary-actions mt-3">
        <button class="btn btn-primary" onclick="window.print()">Print / Save PDF</button>
        <button id="resetBtn2" class="btn btn-danger" type="button">Reset all answers</button>
      </div>
    </section>
  </main>

  <nav class="navbar" aria-label="Navigation">
    <div><button id="prevBtn" class="btn" type="button">‚Üê Previous</button></div>
    <div class="right"><button id="nextBtn" class="btn btn-primary" type="button" disabled>Save &amp; Next ‚Üí</button></div>
  </nav>

<script>
(() => {
  "use strict";

  // =================================================================================================
  //  1. CONFIGURATION & DATA
  // =================================================================================================

  const STORAGE_KEY = 'value-comparisons.v8'; // Bumped to invalidate old caches with layout changes
  const PLACEHOLDER_SVG = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="640" height="480" viewBox="0 0 640 480"><rect width="640" height="480" fill="#f3f4f6"/><g fill="#9ca3af" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" text-anchor="middle"><text x="320" y="240" font-size="20">No image</text></g></svg>`);

  const items = [
      { left:{ name:"Microsoft Xbox Series X ‚Äì 1TB Digital Edition", emoji:"üéÆ", image:"assets/xbox series x.png" }, right:{ name:"Sony PlayStation 5 (PS5) Digital Console Slim", emoji:"üéÆ", image:"assets/ps5.png" } },
      { left:{ name:"Mrs. Butterworth‚Äôs Pancake Syrup", emoji:"ü•û", image:"assets/ms butterworths.webp" }, right:{ name:"Log Cabin Original Syrup", emoji:"ü•û", image:"assets/log cabin.webp" } },
      { left:{ name:"Fruit of the Loom Hoodie", emoji:"üß•", image:"assets/fruit of the loom hoodie.jpg" }, right:{ name:"Jerzees Hoodie", emoji:"üß•", image:"assets/jerzees hoodie.jpg" } },
      { left:{ name:"Nike Air Max 270", emoji:"üëü", image:"assets/nike air max.avif" }, right:{ name:"Adidas Ultraboost", emoji:"üëü", image:"assets/adidas ultraboost.webp" } },
      { left:{ name:"Apple iPhone 16 Pro Max", emoji:"üì±", image:"assets/iphone 16 pro max.jpg" }, right:{ name:"Samsung Galaxy S25 Ultra", emoji:"üì±", image:"assets/samsung s25 ultra.webp" } },
      { left:{ name:"HP Envy 17.3\" Laptop (Ultra 7-155H, 64GB RAM, 1TB SSD)", emoji:"üíª", image:"assets/hp envy.webp" }, right:{ name:"15‚Äù MacBook Air M4 24 GB RAM 1TB SSD", emoji:"üíª", image:"assets/macbook air.jpg" } },
      { left:{ name:"Uniball Vision Rollerball", emoji:"üñäÔ∏è", image:"assets/uniball vision.jpg" }, right:{ name:"Pilot G2 Premium Gel Roller", emoji:"üñäÔ∏è", image:"assets/pilot g2.jpg" } },
      { left:{ name:"Dunkin‚Äô Frozen Chocolate (M)", emoji:"ü•§", image:"assets/frozen-chocolate.png" }, right:{ name:"Starbucks Double Chocolate Chip Frappuccino (Grande)", emoji:"ü•§", image:"assets/chocolate frap.webp" } },
      { left:{ name:"Fitbit Charge 6", emoji:"‚åö", image:"assets/fitbit.jpg" }, right:{ name:"Garmin Vivosmart 5", emoji:"‚åö", image:"assets/garmin watch.jpg" } },
      { left:{ name:"Dyson V11 Vacuum", emoji:"üßπ", image:"assets/dyson vacuum.jpg" }, right:{ name:"Shark Cordless PowerDetect Vacuum", emoji:"üßπ", image:"assets/shark vacuum.webp" } },
      { left:{ name:"SAMSUNG 75\" QLED Q60B Series", emoji:"üì∫", image:"assets/samsung tv.avif" }, right:{ name:"LG 75\" UR9000 Series", emoji:"üì∫", image:"assets/lg tv.webp" } },
      { left:{ name:"KitchenAid Stand Mixer", emoji:"ü•£", image:"assets/kitchenaid mixer.jpg" }, right:{ name:"Cuisinart Stand Mixer", emoji:"ü•£", image:"assets/cuisineart mixer.jpg" } },
      { left:{ name:"Yeti Tundra 45 Cooler", emoji:"üßä", image:"assets/yeti cooler.jpg" }, right:{ name:"RTIC 45 Cooler", emoji:"üßä", image:"assets/rtic cooler.webp" } },
      { left:{ name:"North Face Borealis Commuter Backpack", emoji:"üéí", image:"assets/northface backpack.jpg" }, right:{ name:"Osprey Daylite Plus Commuter Backpack", emoji:"üéí", image:"assets/osprey backpack.webp" } },
      { left:{ name:"HP Envy Printer", emoji:"üñ®Ô∏è", image:"assets/hp envy printer.webp" }, right:{ name:"Canon PIXMA Printer", emoji:"üñ®Ô∏è", image:"assets/canon printer.webp" } },
      { left:{ name:"Levi‚Äôs 501 Jeans", emoji:"üëñ", image:"assets/levis 501.webp" }, right:{ name:"Wrangler Original Fit Jeans", emoji:"üëñ", image:"assets/wrangler jeans.jpg" } },
      { left:{ name:"Ray-Ban Wayfarer Sunglasses", emoji:"üï∂Ô∏è", image:"assets/rayban sunglasses.avif" }, right:{ name:"Oakley Holbrook Sunglasses", emoji:"üï∂Ô∏è", image:"assets/oakley sunglasses.jpg" } },
      { left:{ name:"Apple Watch Series 10", emoji:"‚åö", image:"assets/apple watch.jpg" }, right:{ name:"Samsung Galaxy Watch Ultra (2025)", emoji:"‚åö", image:"assets/samsung watch.webp" } },
    ];

  // =================================================================================================
  //  2. STATE MANAGEMENT
  // =================================================================================================

  const pairs = items.map((it, i) => ({
    id: `pair-${i+1}`,
    left: { title: it.left?.name ?? `Item ${i+1}A`, img: it.left?.image ?? null, emoji: it.left?.emoji ?? '' },
    right: { title: it.right?.name ?? `Item ${i+1}B`, img: it.right?.image ?? null, emoji: it.right?.emoji ?? '' }
  }));
  const TOTAL_PAIRS = pairs.length;

  const defaultAnswer = () => ({ choice:null, leftPrice:'', leftUrl:'', rightPrice:'', rightUrl:'' });
  let state = { currentIndex:0, answers:{}, meta:{ studentName:'', date:'' } };
  let saveTimer;

  function safeLoad() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const p = JSON.parse(raw);
      if (!p || typeof p !== 'object') return;
      state = {
        currentIndex: Number.isFinite(p.currentIndex) ? p.currentIndex : 0,
        answers: p.answers && typeof p.answers === 'object' ? p.answers : {},
        meta: p.meta && typeof p.meta === 'object' ? { studentName:p.meta.studentName||'', date:p.meta.date||'' } : { studentName:'', date:'' }
      };
    } catch (e) { console.warn('Failed to load state from localStorage', e); }
  }

  function persist() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) { console.warn('Failed to save state to localStorage', e); }
  }

  function scheduleSave() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(persist, 250); // Debounced save
  }

  function resetAll() {
    if (!confirm('Are you sure you want to reset all answers? This will clear your saved progress.')) return;
    state = { currentIndex:0, answers:{}, meta:{ studentName:'', date:'' } };
    try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
    render();
  }

  // =================================================================================================
  //  3. DOM ELEMENT CACHING
  // =================================================================================================

  const $ = (s) => document.querySelector(s);
  const elements = {
    itemsView: $('#itemsView'), summaryView: $('#summaryView'), navbar: $('.navbar'),
    startResumeBtn: $('#startResumeBtn'), summaryBtn: $('#summaryBtn'),
    resetBtn: $('#resetBtn'), resetBtn2: $('#resetBtn2'), toItemsBtn: $('#toItemsBtn'),
    prevBtn: $('#prevBtn'), nextBtn: $('#nextBtn'),
    studentNameInput: $('#studentName'), workDateInput: $('#workDate'),
    pairTitle: $('#pairTitle'), progressBar: $('#progressBar'), progressTxt: $('#progressText'),
    choicesWrap: $('.choices'), validationEl: $('#validation'),
    inputsBlock: $('#inputs'),
    imgLeft: $('#imgLeft'), imgRight: $('#imgRight'),
    capLeft: $('#capLeft'), capRight: $('#capRight'),
    leftTitle: $('#leftTitle'), rightTitle: $('#rightTitle'),
    summaryStudent: $('#summaryStudent'), summaryDate: $('#summaryDate'), summaryList: $('#summaryList')
  };
  const inputs = {
    leftPrice: $('#leftPrice'), leftUrl: $('#leftUrl'),
    rightPrice: $('#rightPrice'), rightUrl: $('#rightUrl')
  };

  // =================================================================================================
  //  4. UTILITY & VALIDATION FUNCTIONS
  // =================================================================================================

  const parsePrice = (raw) => {
    if (raw == null) return '';
    const cleaned = String(raw).replace(/[^\d.-]/g, '').replace(/(?!^)-/g, '');
    if (!/\d/.test(cleaned)) return '';
    const n = Number(cleaned);
    return !Number.isFinite(n) || n < 0 ? '' : n.toFixed(2);
  };

  const normalizeUrlInput = (u) => {
    let s = (u || '').trim();
    if (!s) return '';
    if (/^https?:\/\//i.test(s)) return s;
    if (/^\/\//.test(s)) return 'https:' + s;
    if (/^[\w.-]+\.[a-z]{2,}(?:\/.*)?$/i.test(s)) return 'https://' + s;
    return s;
  };

  const isValidUrl = (u) => {
    if (!u || typeof u !== 'string') return false;
    try {
      const url = new URL(u);
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch { return false; }
  };

  const validatePair = (ans) => {
    if (!ans || !ans.choice) return false;
    const lp = parsePrice(ans.leftPrice);
    const rp = parsePrice(ans.rightPrice);
    return !!(lp && rp && isValidUrl(ans.leftUrl) && isValidUrl(ans.rightUrl));
  };

  const completion = () => {
    const complete = pairs.filter(p => validatePair(state.answers[p.id])).length;
    const pct = Math.round((complete / TOTAL_PAIRS) * 100);
    return { complete, pct };
  };

  const firstIncompleteIndex = () => {
    for (let i = 0; i < pairs.length; i++) {
      if (!validatePair(state.answers[pairs[i].id])) return i;
    }
    return 0;
  };

  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // =================================================================================================
  //  5. CORE APPLICATION LOGIC & RENDERING
  // =================================================================================================

  function navigate(step) {
    const nextIndex = Math.max(0, Math.min(state.currentIndex + step, TOTAL_PAIRS - 1));
    if (nextIndex === state.currentIndex) return;
    state.currentIndex = nextIndex;
    scheduleSave();
    render();
  }

  function setImage(el, src) {
    const cleanSrc = (src || '').replace(/&amp;/g, '&') || PLACEHOLDER_SVG;
    el.src = cleanSrc;
    el.onerror = () => { el.onerror = null; el.src = PLACEHOLDER_SVG; };
  }

  function prefetchNextImages() {
    const nextIdx = state.currentIndex + 1;
    if (nextIdx >= TOTAL_PAIRS) return;
    const p = pairs[nextIdx];
    [p.left?.img, p.right?.img].forEach(url => {
      if (!url) return;
      const img = new Image();
      img.referrerPolicy = 'no-referrer';
      img.src = (url || '').replace(/&amp;/g, '&');
    });
  }

  function updateValidationUI(ans, pair) {
    if (!ans.choice) {
      elements.validationEl.className = 'validation validation--error';
      elements.validationEl.textContent = 'Select an item to enter prices and URLs.';
      return;
    }
    const messages = [];
    if (!parsePrice(ans.leftPrice)) messages.push(`Enter a valid price for ‚Äú${pair.left.title}‚Äù.`);
    if (!parsePrice(ans.rightPrice)) messages.push(`Enter a valid price for ‚Äú${pair.right.title}‚Äù.`);
    if (!isValidUrl(ans.leftUrl)) messages.push(`Enter a valid URL for ‚Äú${pair.left.title}‚Äù.`);
    if (!isValidUrl(ans.rightUrl)) messages.push(`Enter a valid URL for ‚Äú${pair.right.title}‚Äù.`);

    if (messages.length) {
      elements.validationEl.className = 'validation validation--error';
      elements.validationEl.textContent = messages.join(' ');
    } else {
      elements.validationEl.className = 'validation validation--ok';
      const nextAction = state.currentIndex === TOTAL_PAIRS - 1 ? 'Save & Summary' : 'Save & Next';
      elements.validationEl.textContent = `Looks good. You can ${nextAction}.`;
    }
  }

  function render() {
    elements.itemsView.classList.remove('hidden');
    elements.summaryView.classList.add('hidden');
    elements.navbar.classList.remove('hidden');

    const hasAnyProgress = !!Object.keys(state.answers).length || !!state.meta.studentName || !!state.meta.date;
    elements.startResumeBtn.textContent = hasAnyProgress ? 'Resume' : 'Start';

    elements.studentNameInput.value = state.meta.studentName || '';
    elements.workDateInput.value = state.meta.date || '';

    const { complete, pct } = completion();
    const currentPairIndex = state.currentIndex + 1;
    elements.pairTitle.textContent = `Pair ${currentPairIndex} of ${TOTAL_PAIRS}`;
    elements.progressTxt.textContent = `Pair ${currentPairIndex} of ${TOTAL_PAIRS} ‚Ä¢ Completed ${complete} of ${TOTAL_PAIRS} ‚Ä¢ ${pct}% complete`;
    elements.progressBar.style.width = `${pct}%`;

    const pair = pairs[state.currentIndex];
    const currentAnswer = state.answers[pair.id] || defaultAnswer();

    elements.capLeft.textContent = `${pair.left.emoji ? pair.left.emoji + ' ' : ''}${pair.left.title}`;
    elements.capRight.textContent = `${pair.right.emoji ? pair.right.emoji + ' ' : ''}${pair.right.title}`;
    elements.leftTitle.textContent = pair.left.title;
    elements.rightTitle.textContent = pair.right.title;

    setImage(elements.imgLeft, pair.left.img);
    setImage(elements.imgRight, pair.right.img);
    elements.imgLeft.alt = pair.left.title;
    elements.imgRight.alt = pair.right.title;

    const leftCard = elements.choicesWrap.querySelector('[data-side="left"]');
    const rightCard = elements.choicesWrap.querySelector('[data-side="right"]');
    leftCard.querySelector('input').checked = currentAnswer.choice === 'left';
    rightCard.querySelector('input').checked = currentAnswer.choice === 'right';
    leftCard.classList.toggle('selected', currentAnswer.choice === 'left');
    rightCard.classList.toggle('selected', currentAnswer.choice === 'right');

    inputs.leftPrice.value = currentAnswer.leftPrice || '';
    inputs.leftUrl.value = currentAnswer.leftUrl || '';
    inputs.rightPrice.value = currentAnswer.rightPrice || '';
    inputs.rightUrl.value = currentAnswer.rightUrl || '';

    elements.inputsBlock.classList.toggle('inputs--hidden', !currentAnswer.choice);

    const isPairValid = validatePair(currentAnswer);
    elements.nextBtn.disabled = !isPairValid;
    elements.prevBtn.disabled = state.currentIndex === 0;
    elements.nextBtn.textContent = (state.currentIndex === TOTAL_PAIRS - 1) ? 'Save & Summary' : 'Save & Next ‚Üí';

    updateValidationUI(currentAnswer, pair);
    prefetchNextImages();
  }

  function renderSummary() {
    elements.itemsView.classList.add('hidden');
    elements.summaryView.classList.remove('hidden');
    elements.navbar.classList.add('hidden');

    elements.summaryStudent.textContent = state.meta.studentName || '‚Äî';
    elements.summaryDate.textContent = state.meta.date || '‚Äî';

    elements.summaryList.innerHTML = pairs.map((p, i) => {
      const ans = state.answers[p.id] || defaultAnswer();
      const isValid = validatePair(ans);
      const isLeftChosen = ans.choice === 'left';
      const isRightChosen = ans.choice === 'right';
      const formatMoney = (nStr) => nStr ? Number(nStr).toLocaleString(undefined, {style:'currency', currency:'USD'}) : '‚Äî';

      return `
        <div class="pair">
          <p class="pair__title">Pair ${i+1} of ${TOTAL_PAIRS} ${isValid ? '' : '<span style="color:var(--danger)">‚Ä¢ Incomplete</span>'}</p>
          <div class="pair__body">
            <div class="item">
              <div class="name">${isLeftChosen ? '<span class="chosen" aria-label="chosen">*</span>' : ''}${escapeHtml(p.left.title)}</div>
              <div class="small">Price: ${formatMoney(parsePrice(ans.leftPrice))}</div>
              <div class="small">URL: ${escapeHtml(ans.leftUrl) || '‚Äî'}</div>
            </div>
            <div class="item">
              <div class="name">${isRightChosen ? '<span class="chosen" aria-label="chosen">*</span>' : ''}${escapeHtml(p.right.title)}</div>
              <div class="small">Price: ${formatMoney(parsePrice(ans.rightPrice))}</div>
              <div class="small">URL: ${escapeHtml(ans.rightUrl) || '‚Äî'}</div>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // =================================================================================================
  //  6. EVENT LISTENERS & INITIALIZATION
  // =================================================================================================

  function handleGenericClick(e) {
    const target = e.target.closest('button');
    if (!target) return;

    const actions = {
      startResumeBtn: () => { state.currentIndex = firstIncompleteIndex(); render(); },
      summaryBtn: renderSummary,
      toItemsBtn: render,
      resetBtn: resetAll,
      resetBtn2: resetAll,
      prevBtn: () => navigate(-1),
      nextBtn: () => {
        persist();
        if (state.currentIndex >= TOTAL_PAIRS - 1) renderSummary(); else navigate(1);
      }
    };
    if (actions[target.id]) actions[target.id]();
  }

  function handleChoice(e) {
    const label = e.target.closest('.choice');
    if (!label) return;
    const side = label.dataset.side;
    if (side !== 'left' && side !== 'right') return;

    state.answers[pairs[state.currentIndex].id] = { ...(state.answers[pairs[state.currentIndex].id] || defaultAnswer()), choice: side };
    scheduleSave();
    render();
    setTimeout(() => (side === 'left' ? inputs.leftPrice : inputs.rightPrice).focus({ preventScroll: true }), 0);
  }
  
  function handleInput(e) {
    const t = e.target;
    if (!(t instanceof HTMLInputElement)) return;
  
    const currentPairId = pairs[state.currentIndex].id;
    const currentAnswer = state.answers[currentPairId] || defaultAnswer();
    let updatedAnswer = {};
  
    if (t === elements.studentNameInput) { state.meta.studentName = t.value.trim(); scheduleSave(); return; }
    if (t === elements.workDateInput) { state.meta.date = t.value; scheduleSave(); return; }
  
    if (t === inputs.leftPrice) updatedAnswer.leftPrice = t.value;
    if (t === inputs.rightPrice) updatedAnswer.rightPrice = t.value;
    if (t === inputs.leftUrl) updatedAnswer.leftUrl = normalizeUrlInput(t.value);
    if (t === inputs.rightUrl) updatedAnswer.rightUrl = normalizeUrlInput(t.value);
  
    state.answers[currentPairId] = { ...currentAnswer, ...updatedAnswer };
    scheduleSave();
    
    const newAnswer = state.answers[currentPairId];
    const isValid = validatePair(newAnswer);
    updateValidationUI(newAnswer, pairs[state.currentIndex]);
    elements.nextBtn.disabled = !isValid;
  
    const { complete, pct } = completion();
    elements.progressTxt.textContent = `Pair ${state.currentIndex + 1} of ${TOTAL_PAIRS} ‚Ä¢ Completed ${complete} of ${TOTAL_PAIRS} ‚Ä¢ ${pct}% complete`;
    elements.progressBar.style.width = `${pct}%`;
  }
  
  function handleBlur(e) {
    const t = e.target;
    if (!(t instanceof HTMLInputElement)) return;
  
    if (t === inputs.leftPrice || t === inputs.rightPrice) {
      const formatted = parsePrice(t.value);
      if (formatted) t.value = formatted;
    }
    if (t === inputs.leftUrl || t === inputs.rightUrl) {
      t.value = normalizeUrlInput(t.value);
    }
    handleInput(e); // Re-run validation and state update on blur
  }

  function init() {
    safeLoad();
    if (!state.meta.date) {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      state.meta.date = `${yyyy}-${mm}-${dd}`;
    }
    render();

    // Delegate event listeners to the body for efficiency
    document.body.addEventListener('click', handleGenericClick);
    elements.choicesWrap.addEventListener('click', handleChoice);
    document.body.addEventListener('input', handleInput);
    document.body.addEventListener('blur', handleBlur, true);
  }

  document.addEventListener('DOMContentLoaded', init);

})();
</script>
</body>
</html>
